name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Node.js jobs
  npm-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: npm ci
      - run: npm audit --audit-level=high

  check-ts-bindings:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - name: Check generated TypeScript bindings
        run: |
          cargo test -p observing-appview -- export_bindings
          git diff --exit-code frontend/src/bindings/

  typecheck-scripts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: npm ci
      - run: npx tsc --project tsconfig.json

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: npm ci
      - run: npm run build

  # Rust jobs
  rust-fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check

  rust-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: taiki-e/cache-cargo-install-action@v3
        with:
          tool: cargo-audit
      - run: cargo audit --file Cargo.lock --ignore RUSTSEC-2023-0071

  rust-clippy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: clippy
      - run: cargo clippy --workspace -- -D warnings

  rust-sqlx:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - uses: taiki-e/cache-cargo-install-action@v3
        with:
          tool: sqlx-cli
          no-default-features: true
          features: postgres
      - working-directory: crates/observing-ingester
        run: cargo sqlx prepare --check

  rust-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - run: cargo test --workspace

  # Build Docker images in parallel with caching
  build-images:
    runs-on: ubuntu-latest
    needs: [npm-audit, check-ts-bindings, typecheck-scripts, build, rust-fmt, rust-audit, rust-clippy, rust-sqlx, rust-test]
    if: github.event_name == 'push'
    strategy:
      matrix:
        include:
          - service: appview
            context: .
            dockerfile: crates/observing-appview/Dockerfile
          - service: ingester
            context: .
            dockerfile: crates/observing-ingester/Dockerfile
          - service: media-proxy
            context: .
            dockerfile: crates/observing-media-proxy/Dockerfile
          - service: taxonomy
            context: .
            dockerfile: crates/observing-taxonomy/Dockerfile
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: gcr.io
          username: _json_key
          password: ${{ secrets.GCP_SA_KEY }}

      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: gcr.io/${{ secrets.GCP_PROJECT_ID }}/observing-${{ matrix.service }}:latest
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  deploy:
    runs-on: ubuntu-latest
    needs: [build-images]
    environment:
      name: production
      url: ${{ steps.deploy-appview.outputs.url }}
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: us-central1
      PUBLIC_URL: https://observ.ing
      MEDIA_PROXY_URL: https://observing-media-proxy-378013734384.us-central1.run.app
      TAXONOMY_URL: https://observing-taxonomy-378013734384.us-central1.run.app
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Deploy appview
        id: deploy-appview
        run: |
          URL=$(gcloud run deploy observing-appview \
            --image=gcr.io/$PROJECT_ID/observing-appview:latest \
            --region=$REGION \
            --allow-unauthenticated \
            --add-cloudsql-instances=$PROJECT_ID:$REGION:observing-db \
            --set-env-vars=DB_HOST=/cloudsql/$PROJECT_ID:$REGION:observing-db,DB_NAME=observing,DB_USER=postgres,PUBLIC_URL=$PUBLIC_URL,MEDIA_PROXY_URL=$MEDIA_PROXY_URL,TAXONOMY_SERVICE_URL=$TAXONOMY_URL \
            --set-secrets=DB_PASSWORD=observing-db-password:latest \
            --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Deploy ingester
        run: |
          gcloud run deploy observing-ingester \
            --image=gcr.io/$PROJECT_ID/observing-ingester:latest \
            --region=$REGION \
            --allow-unauthenticated \
            --cpu=1 \
            --memory=2Gi \
            --add-cloudsql-instances=$PROJECT_ID:$REGION:observing-db \
            --set-env-vars=RUST_LOG=observing_ingester=info,DB_HOST=/cloudsql/$PROJECT_ID:$REGION:observing-db,DB_NAME=observing,DB_USER=postgres,JETSTREAM_URL=wss://jetstream2.us-east.bsky.network/subscribe \
            --set-secrets=DB_PASSWORD=observing-db-password:latest \
            --min-instances=1 \
            --max-instances=1 \
            --timeout=3600

      - name: Deploy media-proxy
        run: |
          gcloud run deploy observing-media-proxy \
            --image=gcr.io/$PROJECT_ID/observing-media-proxy:latest \
            --region=$REGION \
            --allow-unauthenticated \
            --set-env-vars=RUST_LOG=observing_media_proxy=info,LOG_FORMAT=json

      - name: Deploy taxonomy
        run: |
          gcloud run deploy observing-taxonomy \
            --image=gcr.io/$PROJECT_ID/observing-taxonomy:latest \
            --region=$REGION \
            --allow-unauthenticated \
            --set-env-vars=RUST_LOG=observing_taxonomy=info,LOG_FORMAT=json
