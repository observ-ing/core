name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Node.js jobs - run in parallel
  npm-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: npm ci
      - run: npm audit --audit-level=high

  prisma-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: npm ci
      - run: npx prisma validate

  check-generated:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: npm ci
      - name: Check generated types
        run: |
          npm run generate-types
          git diff --exit-code packages/biosky-appview/src/generated/
      - name: Check OpenAPI spec
        run: |
          npm run openapi -w biosky-shared
          git diff --exit-code packages/biosky-shared/openapi.json

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: npm ci
      - run: npm run build

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: npm ci
      - run: npm run test:run

  # Rust jobs - run in parallel
  rust-fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --manifest-path packages/biosky-ingester/Cargo.toml -- --check

  rust-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: cargo install cargo-audit
      - run: cargo audit --file Cargo.lock --ignore RUSTSEC-2023-0071

  rust-clippy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/biosky-ingester
      - run: cargo clippy --manifest-path packages/biosky-ingester/Cargo.toml -- -D warnings
        env:
          SQLX_OFFLINE: true

  rust-sqlx:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/biosky-ingester
      - run: cargo install sqlx-cli --no-default-features --features postgres
      - working-directory: packages/biosky-ingester
        run: cargo sqlx prepare --check

  rust-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/biosky-ingester
      - run: cargo test --manifest-path packages/biosky-ingester/Cargo.toml
        env:
          SQLX_OFFLINE: true

  deploy:
    runs-on: ubuntu-latest
    needs: [npm-audit, prisma-validate, check-generated, build, test, rust-fmt, rust-audit, rust-clippy, rust-sqlx, rust-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - run: gcloud builds submit --config cloudbuild.yaml
