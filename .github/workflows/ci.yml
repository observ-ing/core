name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Node.js jobs - run in parallel
  npm-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: npm ci
      - run: npm audit --audit-level=high

  prisma-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: npm ci
      - run: npx prisma validate

  check-generated:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: npm ci
      - name: Check generated types
        run: |
          npm run generate-types
          git diff --exit-code packages/biosky-appview/src/generated/
      - name: Check OpenAPI spec
        run: |
          npm run openapi -w biosky-shared
          git diff --exit-code packages/biosky-shared/openapi.json

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: npm ci
      - run: npm run build

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: npm ci
      - run: npm run build -w biosky-shared
      - run: npm run test:run

  # Rust jobs - run in parallel
  rust-fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --manifest-path packages/biosky-ingester/Cargo.toml -- --check

  rust-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: taiki-e/cache-cargo-install-action@v3
        with:
          tool: cargo-audit
      - run: cargo audit --file Cargo.lock --ignore RUSTSEC-2023-0071

  rust-clippy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/biosky-ingester
      - run: cargo clippy --manifest-path packages/biosky-ingester/Cargo.toml -- -D warnings
        env:
          SQLX_OFFLINE: true

  rust-sqlx:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/biosky-ingester
      - uses: taiki-e/cache-cargo-install-action@v3
        with:
          tool: sqlx-cli
          no-default-features: true
          features: postgres
      - working-directory: packages/biosky-ingester
        run: cargo sqlx prepare --check

  rust-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/biosky-ingester
      - run: cargo test --manifest-path packages/biosky-ingester/Cargo.toml
        env:
          SQLX_OFFLINE: true

  # Build Docker images in parallel with caching
  build-images:
    runs-on: ubuntu-latest
    needs: [npm-audit, prisma-validate, check-generated, build, test, rust-fmt, rust-audit, rust-clippy, rust-sqlx, rust-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        include:
          - service: appview
            context: .
            dockerfile: packages/biosky-appview/Dockerfile
          - service: api
            context: .
            dockerfile: packages/biosky-api/Dockerfile
          - service: ingester
            context: packages/biosky-ingester
            dockerfile: packages/biosky-ingester/Dockerfile
          - service: media-proxy
            context: .
            dockerfile: packages/biosky-media-proxy/Dockerfile
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: gcr.io
          username: _json_key
          password: ${{ secrets.GCP_SA_KEY }}

      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: gcr.io/${{ secrets.GCP_PROJECT_ID }}/biosky-${{ matrix.service }}:latest
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  deploy:
    runs-on: ubuntu-latest
    needs: [build-images]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: ${{ steps.deploy-appview.outputs.url }}
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: us-central1
      PUBLIC_URL: https://biosky-appview-378013734384.us-central1.run.app
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Deploy appview
        id: deploy-appview
        run: |
          URL=$(gcloud run deploy biosky-appview \
            --image=gcr.io/$PROJECT_ID/biosky-appview:latest \
            --region=$REGION \
            --allow-unauthenticated \
            --add-cloudsql-instances=$PROJECT_ID:$REGION:biosky-db \
            --set-env-vars=DB_HOST=/cloudsql/$PROJECT_ID:$REGION:biosky-db,DB_NAME=biosky,DB_USER=postgres,PUBLIC_URL=$PUBLIC_URL \
            --set-secrets=DB_PASSWORD=biosky-db-password:latest,INTERNAL_SECRET=biosky-internal-secret:latest \
            --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Deploy api
        run: |
          gcloud run deploy biosky-api \
            --image=gcr.io/$PROJECT_ID/biosky-api:latest \
            --region=$REGION \
            --allow-unauthenticated \
            --add-cloudsql-instances=$PROJECT_ID:$REGION:biosky-db \
            --set-env-vars=DB_HOST=/cloudsql/$PROJECT_ID:$REGION:biosky-db,DB_NAME=biosky,DB_USER=postgres,APPVIEW_URL=$PUBLIC_URL,CORS_ORIGINS=$PUBLIC_URL \
            --set-secrets=DB_PASSWORD=biosky-db-password:latest,INTERNAL_SECRET=biosky-internal-secret:latest

      - name: Deploy ingester
        run: |
          gcloud run deploy biosky-ingester \
            --image=gcr.io/$PROJECT_ID/biosky-ingester:latest \
            --region=$REGION \
            --allow-unauthenticated \
            --cpu=1 \
            --memory=2Gi \
            --add-cloudsql-instances=$PROJECT_ID:$REGION:biosky-db \
            --set-env-vars=RUST_LOG=biosky_ingester=info,DB_HOST=/cloudsql/$PROJECT_ID:$REGION:biosky-db,DB_NAME=biosky,DB_USER=postgres,JETSTREAM_URL=wss://jetstream2.us-east.bsky.network/subscribe \
            --set-secrets=DB_PASSWORD=biosky-db-password:latest \
            --min-instances=1 \
            --max-instances=1 \
            --timeout=3600

      - name: Deploy media-proxy
        run: |
          gcloud run deploy biosky-media-proxy \
            --image=gcr.io/$PROJECT_ID/biosky-media-proxy:latest \
            --region=$REGION \
            --allow-unauthenticated \
            --set-env-vars=RUST_LOG=biosky_media_proxy=info,LOG_FORMAT=json
