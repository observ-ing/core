generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [postgis]
}

model IngesterState {
  key       String   @id
  value     String
  updatedAt DateTime @default(now()) @map("updated_at")

  @@map("ingester_state")
}

model Occurrence {
  uri                           String   @id
  cid                           String
  did                           String
  scientificName                String?  @map("scientific_name")
  eventDate                     DateTime @map("event_date")
  // PostGIS geography type - use raw SQL for spatial queries
  location                      Unsupported("geography(Point, 4326)")
  coordinateUncertaintyMeters   Int?     @map("coordinate_uncertainty_meters")
  // Darwin Core administrative geography fields
  continent                     String?
  country                       String?
  countryCode                   String?  @map("country_code")
  stateProvince                 String?  @map("state_province")
  county                        String?
  municipality                  String?
  locality                      String?
  waterBody                     String?  @map("water_body")
  verbatimLocality              String?  @map("verbatim_locality")
  occurrenceRemarks             String?  @map("occurrence_remarks")
  associatedMedia               Json?    @map("associated_media")
  recordedBy                    String?  @map("recorded_by")
  taxonId                       String?  @map("taxon_id")
  taxonRank                     String?  @map("taxon_rank")
  vernacularName                String?  @map("vernacular_name")
  kingdom                       String?
  phylum                        String?
  class                         String?
  order                         String?
  family                        String?
  genus                         String?
  createdAt                     DateTime @map("created_at")
  indexedAt                     DateTime @default(now()) @map("indexed_at")

  identifications  Identification[]
  comments         Comment[]
  interactionsAsA  Interaction[]    @relation("InteractionSubjectA")
  interactionsAsB  Interaction[]    @relation("InteractionSubjectB")

  @@index([location], name: "occurrences_location_idx", type: Gist)
  @@index([scientificName], name: "occurrences_scientific_name_idx")
  @@index([did], name: "occurrences_did_idx")
  @@index([eventDate], name: "occurrences_event_date_idx")
  @@map("occurrences")
}

model Identification {
  uri                              String   @id
  cid                              String
  did                              String
  subjectUri                       String   @map("subject_uri")
  subjectCid                       String   @map("subject_cid")
  scientificName                   String   @map("scientific_name")
  taxonRank                        String?  @map("taxon_rank")
  identificationQualifier          String?  @map("identification_qualifier")
  taxonId                          String?  @map("taxon_id")
  identificationRemarks            String?  @map("identification_remarks")
  identificationVerificationStatus String?  @map("identification_verification_status")
  typeStatus                       String?  @map("type_status")
  isAgreement                      Boolean  @default(false) @map("is_agreement")
  dateIdentified                   DateTime @map("date_identified")
  indexedAt                        DateTime @default(now()) @map("indexed_at")

  occurrence Occurrence @relation(fields: [subjectUri], references: [uri], onDelete: Cascade)

  @@index([subjectUri], name: "identifications_subject_uri_idx")
  @@index([did], name: "identifications_did_idx")
  @@index([scientificName], name: "identifications_scientific_name_idx")
  @@map("identifications")
}

model Comment {
  uri        String   @id
  cid        String
  did        String
  subjectUri String   @map("subject_uri")
  subjectCid String   @map("subject_cid")
  body       String
  replyToUri String?  @map("reply_to_uri")
  replyToCid String?  @map("reply_to_cid")
  createdAt  DateTime @map("created_at")
  indexedAt  DateTime @default(now()) @map("indexed_at")

  occurrence Occurrence @relation(fields: [subjectUri], references: [uri], onDelete: Cascade)

  @@index([subjectUri], name: "comments_subject_uri_idx")
  @@index([did], name: "comments_did_idx")
  @@index([replyToUri], name: "comments_reply_to_uri_idx")
  @@map("comments")
}

model Interaction {
  uri                    String   @id
  cid                    String
  did                    String
  subjectAOccurrenceUri  String?  @map("subject_a_occurrence_uri")
  subjectAOccurrenceCid  String?  @map("subject_a_occurrence_cid")
  subjectASubjectIndex   Int      @default(0) @map("subject_a_subject_index")
  subjectATaxonName      String?  @map("subject_a_taxon_name")
  subjectAKingdom        String?  @map("subject_a_kingdom")
  subjectBOccurrenceUri  String?  @map("subject_b_occurrence_uri")
  subjectBOccurrenceCid  String?  @map("subject_b_occurrence_cid")
  subjectBSubjectIndex   Int      @default(0) @map("subject_b_subject_index")
  subjectBTaxonName      String?  @map("subject_b_taxon_name")
  subjectBKingdom        String?  @map("subject_b_kingdom")
  interactionType        String   @map("interaction_type")
  direction              String   @default("AtoB")
  confidence             String?
  comment                String?
  createdAt              DateTime @map("created_at")
  indexedAt              DateTime @default(now()) @map("indexed_at")

  occurrenceA Occurrence? @relation("InteractionSubjectA", fields: [subjectAOccurrenceUri], references: [uri], onDelete: Cascade)
  occurrenceB Occurrence? @relation("InteractionSubjectB", fields: [subjectBOccurrenceUri], references: [uri], onDelete: Cascade)

  @@index([did], name: "interactions_did_idx")
  @@index([subjectAOccurrenceUri], name: "interactions_subject_a_occurrence_idx")
  @@index([subjectBOccurrenceUri], name: "interactions_subject_b_occurrence_idx")
  @@index([interactionType], name: "interactions_type_idx")
  @@map("interactions")
}
